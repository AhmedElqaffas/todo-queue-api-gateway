# todo-queue-api-gateway
A Krakend API gateway that handles verifying Cognito JWT before forwarding the request to the backend


# How to run the gateway

Build the krakend docker image:

```
cd <repo_directory>
docker build -t krakend-gateway .
```

Then run the container, run the following command, replace `backend_url`, `user_pool_id`, `client_id` and `redirect_url` with their actual values:

```
docker run -p 8000:8000 -e FC_ENABLE=1 -e BACKEND_URL=<backend_url> -e COGNITO_URL="https://<user_pool_id>.amazoncognito.com/login?client_id=<client_id>&response_type=code&scope=aws.cognito.signin.user.admin+email+openid+phone&redirect_uri=<redirect_url>" krakend-gateway
```

# JWT Verification Plugin

A custom Go plugin (I called 'krakend-cognito-jwt') is used to verify the Cognito JWT token before forwarding the request to the backend.
If the token is valid, an "Todo-User-Email" header is added to the request, otherwise the request is blocked.
I'm not familiar with Go language syntax so the plugin was generated by DeepSeek V3.

## How to Build

After applying changes to the plugin, rebuild it using the following commands:
```
cd path/to/krakend-cognito-jwt
docker build -t krakend-plugin-builder .
```

The above command creates a docker image that builds the plugin with the same Go version used in Krakend v2.9.3 (which is being used in this project).

To extract the `.so` file from the docker container to your host, run the following commands:
```
docker create --name plugin-builder krakend-plugin-builder
docker cp plugin-builder:/app/krakend-cognito-jwt.so .
docker rm plugin-builder
```

The output `.so` file is already committed in this repo so that we can build the krakend image directly, without having to build the plugin first.

